<!DOCTYPE html>
<html>
<head>
  <title>Ler QR Code com a câmera do navegador e AR.js</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.rawgit.com/cozmo/jsQR/master/dist/jsQR.js"></script>
</head>
<body>
  <h1>Ler QR Code com a câmera do navegador e AR.js</h1>
  <script>
    AFRAME.registerComponent('barcode-detector', {
      schema: {
        qrText: { type: 'string', default: '' }
      },
      init: function () {
        this.canvas = document.createElement('canvas');
        this.context = this.canvas.getContext('2d');
        this.textPlane = document.createElement('a-plane');
        this.textPlane.setAttribute('width', '2');
        this.textPlane.setAttribute('height', '0.5');
        this.textPlane.setAttribute('color', 'black');
        this.textPlane.setAttribute('position', '0 0.1 0');
        this.textPlane.setAttribute('text', {
          value: '',
          align: 'center',
          wrapCount: 20,
          color: 'white'
        });
        this.el.appendChild(this.textPlane);
        this.detectQRCode();
      },
      detectQRCode: function () {
        const self = this;
        const marker = self.el.object3DMap['a-marker'];
        if (marker && marker.children && marker.children.length > 0) {
          const mesh = marker.children[0];
          const width = mesh.geometry.parameters.width;
          const height = mesh.geometry.parameters.height;
          self.canvas.width = width;
          self.canvas.height = height;
          self.context.drawImage(self.el.sceneEl.canvas, 0, 0, width, height);
          const imageData = self.context.getImageData(0, 0, width, height);
          const code = jsQR(imageData.data, width, height, {
            inversionAttempts: 'dontInvert',
          });
          if (code) {
            self.textPlane.setAttribute('text', {
              value: code.data
            });
            self.el.setAttribute('barcode-detector', 'qrText', code.data);
            self.textPlane.setAttribute('visible', 'true');
          } else {
            self.textPlane.setAttribute('visible', 'false');
            setTimeout(() => {
              self.detectQRCode();
            }, 500);
          }
        } else {
          self.textPlane.setAttribute('visible', 'false');
          setTimeout(() => {
            self.detectQRCode();
          }, 500);
        }
      },
      update: function () {
        this.textPlane.setAttribute('text', {
          value: this.data.qrText
        });
      },
      remove: function () {
        this.textPlane.parentNode.removeChild(this.textPlane);
      }
    });
  </script>
  <a-scene embedded arjs="sourceType: webcam;">
    <a-marker preset="hiro">
      <a-entity position="0 0 0" barcode-detector></a-entity>
      <a-entity position="0 0.1 0" rotation="-90 0 0" scale="0.5 0.5 0.5" material="color: white">
        <a-plane width="2" height="0.5" color="black" position="0 0 0" text="align: center; wrapCount: 20; color: white"></a-plane>
        </a-entity>
    </a-marker>
    <a-camera-static></a-camera-static>
    </a-scene>
</body>
</html>
    